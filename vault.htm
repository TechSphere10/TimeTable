<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timetable Vault</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <style>
        :root { --primary: #004085; --primary-dark: #002c5c; --secondary: #3b82f6; --text: #1e293b; --bg-light: #f8fafc; --border-color: #e2e8f0; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-light); margin: 0; padding: 0; }
        .header { display: flex; align-items: center; justify-content: space-between; padding: 5px 20px; background: linear-gradient(135deg, var(--primary) 0%, #0056b3 100%); color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .logo-left img, .logo-right img { width: 60px; height: 60px; border-radius: 50%; }
        .header-text { text-align: center; flex: 1; }
        .header-text h1 { margin: 0; font-size: 22px; }
        .header-text p { margin: 5px 0 0; font-size: 14px; opacity: 0.9; }
        .container { max-width: 1400px; margin: 30px auto; padding: 20px; }
        .page-title { color: var(--primary-dark); font-size: 28px; font-weight: 700; margin-bottom: 20px; text-align: center; }
        .vault-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; }
        .timetable-card { background: white; border-radius: 12px; box-shadow: 0 6px 20px rgba(30, 64, 175, 0.1); border-left: 5px solid var(--secondary); transition: all 0.3s ease; }
        .timetable-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(30, 64, 175, 0.2); }
        .card-body { padding: 20px; }
        .card-title { font-size: 18px; font-weight: 700; color: var(--primary-dark); margin: 0 0 15px 0; }
        .card-info { font-size: 14px; color: #64748b; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .card-footer { padding: 15px 20px; background-color: #f8fafc; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; }
        .btn-view { padding: 8px 18px; background-color: var(--secondary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; text-decoration: none; }
        #loading, #empty-state { text-align: center; padding: 50px; font-size: 18px; color: var(--text); }
        .btn-back { position: absolute; top: 90px; left: 20px; padding: 10px 20px; background-color: var(--secondary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; text-decoration: none; }
    </style>
</head>
<body>

<div class="header">
    <div class="logo-left"><img src="left-logo.png" alt="Logo"></div>
    <div class="header-text">
        <h1>Maharaja Institute of Technology, Mysore</h1>
        <p>Timetable Vault</p>
    </div>
    <div class="logo-right"><img src="right-logo.png" alt="Logo"></div>
</div>

<a href="page.htm" class="btn-back">‚Üê Back to Home</a>

<div class="container">
    <h1 class="page-title">Finalized Timetables</h1>
    <div id="vault-grid" class="vault-grid">
        <div id="loading">Loading finalized timetables...</div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const grid = document.getElementById('vault-grid');
        
        try {
            const { data, error } = await supabase
                .from('timetable_status')
                .select('*')
                .eq('is_finalized', true)
                .order('department', { ascending: true })
                .order('academic_year', { ascending: false });

            if (error) throw error;

            if (!data || data.length === 0) {
                grid.innerHTML = '<div id="empty-state">No finalized timetables found in the vault.</div>';
                return;
            }

            // Clear loading message
            grid.innerHTML = '';

            data.forEach(status => {
                const card = document.createElement('div');
                card.className = 'timetable-card';
                
                card.innerHTML = `
                    <div class="card-body">
                        <h3 class="card-title">${status.department} - Sem ${status.semester}</h3>
                        <p class="card-info"><strong>Year:</strong> ${status.year}</p>
                        <p class="card-info"><strong>Academic Year:</strong> ${status.academic_year}</p>
                    </div>
                    <div class="card-footer">
                        <a href="#" class="btn-view" onclick="viewTimetable('${status.department}', '${status.academic_year}', '${status.year}', '${status.semester}')">View Timetable</a>
                    </div>
                `;
                grid.appendChild(card);
            });

        } catch (err) {
            console.error('Error loading vault:', err);
            grid.innerHTML = '<div id="empty-state">Could not load timetables from the vault.</div>';
        }
    });

    function viewTimetable(department, academicYear, year, semester) {
        // Redirect to a read-only view
        // We will need to modify enhanced.htm to handle these view-only parameters
        const params = new URLSearchParams({
            view: 'true',
            dept: department,
            ay: academicYear,
            yr: year,
            sem: semester
        });
        window.location.href = `enhanced.htm?${params.toString()}`;
    }
</script>

</body>
</html>
