<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Timetable Generator - Setup</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #004085; --primary-dark: #002c5c; --secondary: #3b82f6; --success: #22c55e; --warning: #f97316; --danger: #ef4444; --info: #0ea5e9; --text: #1e293b; --text-light: #64748b; --bg-light: #f8fafc; --border-color: #e2e8f0; --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
        * { box-sizing: border-box; }
        body { margin: 0; background: var(--bg-gradient); color: var(--text); font: 400 14px/1.5 'Segoe UI', Arial, sans-serif; min-height: 100vh; padding-top: 80px; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { display: flex; align-items: center; justify-content: space-between; padding: 5px 20px; background: linear-gradient(135deg, var(--primary) 0%, #0056b3 100%); color: white; flex-wrap: wrap; box-shadow: 0 4px 15px rgba(0,0,0,0.2); width: 100%; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; }
        .logo-left, .logo-right { width: 70px; height: 70px; display: flex; align-items: center; justify-content: center; }
        .logo-left img, .logo-right img { width: 60px; height: 60px; object-fit: cover; border-radius: 50%; background: rgba(255,255,255,0.1); padding: 5px; }
        .header-text { text-align: center; flex: 1; min-width: 280px; }
        .header-text h1 { margin: 2px 0; font-weight: 700; font-size: 16px; line-height: 1.2; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        .header-text h1:nth-child(2) { font-size: 20px; margin: 3px 0; color: #e0f2fe; }
        .main-grid { display: grid; grid-template-columns: 1fr; gap: 25px; }
        .content-area { width: 100%; }
        .card { background: white; border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: all 0.3s ease; overflow: hidden; }
        .card-header { font-size: 18px; color: var(--primary-dark); font-weight: 700; padding: 16px 24px; background: linear-gradient(135deg, #eef2f3, #f8fafc); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 10px; }
        .card-body { padding: 20px; }
        label { display: block; font-size: 13px; color: var(--text-light); margin-bottom: 6px; font-weight: 600; }
        input, select { width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); background: white; color: var(--text); border-radius: 8px; font-size: 14px; outline: none; transition: all 0.3s ease; }
        input:focus, select:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 10px; padding: 12px 24px; border: none; background: var(--secondary); color: white; border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 600; text-decoration: none; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4); }
        .btn:disabled { background: #9ca3af; cursor: not-allowed; box-shadow: none; transform: none; }
        .btn-success { background: linear-gradient(135deg, #22c55e, #16a34a); box-shadow: 0 4px 15px rgba(34, 197, 94, 0.2); border-radius: 10px; }
        .btn-success:hover { box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4); transform: translateY(-2px); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .input-group { display: flex; flex-direction: column; gap: 6px; }
        .faculty-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 20px; margin-top: 20px; }
        .subject-card { background: #f8fafc; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid var(--border-color); transition: all 0.3s; height: fit-content; padding: 15px; }
        .subject-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(30, 64, 175, 0.15); }
        .subject-card h3 { font-size: 16px; color: var(--primary-dark); margin: 0 0 8px 0; font-weight: 700; }
        .section-row { display: grid; grid-template-columns: 80px 1fr; gap: 10px; align-items: center; padding: 10px; background: var(--bg-light); border-radius: 6px; margin-bottom: 10px; transition: all 0.2s; border: 1px solid var(--border-color); }
        .section-row:hover { background: #f1f5f9; }
        .section-row label { margin: 0; padding: 0; font-size: 13px; font-weight: 600; color: var(--text-light); text-align: right; }
        .section-row select { font-size: 13px; padding: 8px; border-radius: 6px; }
        .subjects-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 20px; }
        .subject-item { padding: 15px; background: white; border-radius: 8px; border-left: 4px solid var(--info); box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: all 0.3s; border: 1px solid var(--border-color); position: relative; overflow: hidden; }
        .subject-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(30, 64, 175, 0.15); border-left-color: var(--secondary); }
        .subject-item strong { color: var(--primary-dark); font-size: 15px; display: block; margin-bottom: 8px; }
        .subject-item span { color: var(--text-light); font-size: 13px; display: block; line-height: 1.6; }
        .subject-item .badge { display: inline-block; padding: 4px 10px; background: #e0e7ff; color: #4338ca; border-radius: 12px; font-size: 11px; font-weight: 600; margin-right: 5px; margin-top: 5px; }
        .hidden { display: none; }
        .wizard-steps { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; position: relative; }
        .step { display: flex; align-items: center; gap: 10px; padding: 10px 20px; border-radius: 50px; background: white; border: 1px solid var(--border-color); color: var(--text-light); font-weight: 600; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .step .step-number { background: var(--border-color); color: var(--text-light); width: 30px; height: 30px; border-radius: 50%; display: grid; place-items: center; font-size: 14px; }
        .step.active { background: #dbeafe; border-color: var(--secondary); color: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(59, 130, 246, 0.2); }
        .step.active .step-number { background: var(--secondary); color: white; }
        .step.completed { background: #dcfce7; border-color: var(--success); color: #14532d; }
        .step.completed .step-number { background: var(--success); color: white; font-weight: bold; }
        .button-group { display: flex; justify-content: center; gap: 15px; margin-top: 25px; }
    </style>
</head>
<body>
<div class="header">
<div class="logo-left"><img src="left-logo.png" alt="MET Logo"></div>
<div class="header-text">
<h1>MAHARAJA EDUCATION TRUST (R), MYSURU</h1>
<h1>MAHARAJA INSTITUTE OF TECHNOLOGY, MYSORE</h1>
<h1 style="font-size: 14px; font-weight: 500; opacity: 0.9;">An Autonomous Institution Affiliated to VTU, Belagavi</h1>
</div> 
<div class="logo-right"><img src="right-logo.png" alt="Circle Logo"></div>
</div>

<div class="container">
    <div class="wizard-steps">
        <div class="step active" id="step1">
            <div class="step-number">1</div>
            <div class="step-label">Setup</div>
        </div>
        <div class="step" id="step2">
            <div class="step-number">2</div>
            <div class="step-label">Subjects</div>
        </div>
        <div class="step" id="step3">
            <div class="step-number">3</div>
            <div class="step-label">Faculty</div>
        </div>
    </div>

<div class="main-grid">
<div class="content-area">
<div id="setupStep">
    <div class="card">
        <div class="card-header">‚öôÔ∏è 1. Timetable Configuration</div>
        <div class="card-body">
            <div class="form-grid">
                <div class="input-group">
                    <label>Academic Year</label> 
                    <input id="academicYear" type="text" placeholder="e.g. 2024-25" value="2024-25" />
                </div>
                <div class="input-group">
                    <label>Year</label> 
                    <select id="yearSelect">
                        <option value="">--Select--</option>
                        <option value="1">1st Year</option>
                        <option value="2">2nd Year</option>
                        <option value="3">3rd Year</option>
                        <option value="4">4th Year</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Semester</label> 
                    <select id="semesterSelect" disabled>
                        <option value="">--Select Year First--</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Number of Sections</label> 
                    <input id="numSections" type="number" min="1" max="10" value="1" />
                </div>
            </div>
            <div class="button-group">
                <button class="btn" onclick="loadSubjects()">‚û°Ô∏è Load Subjects</button>
            </div>
        </div>
    </div>
</div>

<div id="subjectsDisplay" class="hidden">
    <div class="card">
        <div class="card-header">üìö 2. Loaded Subjects</div>
        <div class="card-body">
            <div id="subjectsList"></div>
            <div class="button-group">
                <button class="btn" onclick="showFacultyAssignment()">‚û°Ô∏è Assign Faculty</button>
            </div>
        </div>
    </div>
</div>

<div id="facultyAssignment" class="hidden">
    <div class="card">
        <div class="card-header">üë®‚Äçüè´ 3. Faculty Assignment</div>
        <div class="card-body">
            <div id="subjectCards"></div>
            <div class="button-group">
                <button class="btn btn-success" onclick="openGenerator()">üöÄ Generate Timetable</button>
            </div>
        </div>
    </div>
</div>
</div>
</div>
</div>

<script>
const SUPABASE_URL = 'https://bkmzyhroignpjebfpqug.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJrbXp5aHJvaWducGplYmZwcXVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MjA1NDUsImV4cCI6MjA3Mjk5NjU0NX0.ICE2eYzFZvz0dtNpAa5YlJTZD-idc2J76wn1ZeHwwck';
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
const urlParams=new URLSearchParams(window.location.search);
const currentDepartment=urlParams.get('dept')||localStorage.getItem('currentDepartment')||'ISE';
let loadedSubjects=[];
let allFacultyList=[]; // Will store faculty from all departments

async function loadAvailableData(){
try{
const{data,error}=await supabase.from('subjects').select('academic_year,year,semester').eq('department',currentDepartment);
if(error)throw error;
if(!data||data.length===0)return;
const uniqueYears=new Set();
data.forEach(d=>uniqueYears.add(d.academic_year));
const aySelect=document.getElementById('academicYear');
if(uniqueYears.size>0)aySelect.value=Array.from(uniqueYears)[0];
}catch(err){console.error(err)}
}

document.getElementById('yearSelect').onchange=function(){
const year=this.value;
const semSelect=document.getElementById('semesterSelect');
semSelect.innerHTML='<option value="">--Select--</option>';
if(year){
const sems={'1':['1','2'],'2':['3','4'],'3':['5','6'],'4':['7','8']}[year];
sems.forEach(s=>{
const opt=document.createElement('option');
opt.value=s;
opt.textContent='Semester '+s;
semSelect.appendChild(opt);
});
}
};

loadAvailableData();

function updateWizard(step) {
    // Remove all states first
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active', 'completed'));
    
    // Set states based on the current step
    if (step > 1) document.getElementById('step1').classList.add('completed');
    else if (step === 1) document.getElementById('step1').classList.add('active');

    if (step > 2) document.getElementById('step2').classList.add('completed');
    else if (step === 2) document.getElementById('step2').classList.add('active');

    if (step === 3) document.getElementById('step3').classList.add('active');

    // Hide all step content sections
    document.getElementById('setupStep').classList.add('hidden');
    document.getElementById('subjectsDisplay').classList.add('hidden');
    document.getElementById('facultyAssignment').classList.add('hidden');

    // Show the correct content section for the current step
    if (step === 1) document.getElementById('setupStep').classList.remove('hidden');
    if (step === 2) document.getElementById('subjectsDisplay').classList.remove('hidden');
    if (step === 3) document.getElementById('facultyAssignment').classList.remove('hidden');
}

async function loadSubjects(){
const ay=document.getElementById('academicYear').value.trim();
const year=document.getElementById('yearSelect').value;
const sem=document.getElementById('semesterSelect').value;
if(!ay||!year||!sem){alert('Please fill all fields');return}
try{
const{data,error}=await supabase.from('subjects').select('*').eq('department',currentDepartment).eq('academic_year',ay).eq('year',parseInt(year)).eq('semester',parseInt(sem));
if(error) throw error;
if(!data||data.length===0){alert('No subjects found');return}
loadedSubjects=data;
await loadAllFaculty(); // Load all faculty for cross-dept handling
updateWizard(2);
displaySubjects();
}catch(err){alert('Error: '+err.message)}
}

async function loadAllFaculty(){
try{
const{data,error}=await supabase.from('faculty').select('*'); // Fetch all faculty
if(error)throw error;
allFacultyList=data||[];
}catch(err){console.error(err)}
}

function displaySubjects(){
const container=document.getElementById('subjectsList');
container.innerHTML='<div class="subjects-grid">'+loadedSubjects.map(s=>`
<div class="subject-item">
<strong>üìö ${s.name}</strong>
<span><span class="badge" style="background-color: #eef2ff; color: #4338ca;">Credits: ${s.credits}</span><span class="badge" style="background-color: #fefce8; color: #854d0e;">Type: ${s.type}</span><span class="badge" style="background-color: #f0fdf4; color: #166534;">Hours: ${s.weekly_hours}/week</span></span>
</div>
`).join('')+'</div>';
document.getElementById('subjectsDisplay').classList.remove('hidden');
document.getElementById('facultyAssignment').classList.add('hidden');
document.getElementById('setupStep').classList.add('hidden');
}

function showFacultyAssignment(){
const numSections=parseInt(document.getElementById('numSections').value)||1;
const container=document.getElementById('subjectCards');
let html='<div class="faculty-grid">';
loadedSubjects.forEach((subject,idx)=>{
    // Determine which faculty list to use
    const facultyForSubject = subject.is_cross_dept && subject.teaching_dept
        ? allFacultyList.filter(f => f.department === subject.teaching_dept)
        : allFacultyList.filter(f => f.department === currentDepartment);

    const teachingDeptInfo = subject.is_cross_dept ? `<span style="color: var(--warning); font-weight: bold; font-size: 12px; margin-left: 8px;">(from ${subject.teaching_dept})</span>` : '';

let sectionsHTML='';
for(let i=1;i<=numSections;i++){
    const sectionLetter = String.fromCharCode(64 + i); // A, B, C, etc.
    sectionsHTML+=`
    <div class="section-row">
    <label>Sec ${sectionLetter}</label>
    <select id="faculty_s${i}_sub${idx}" data-subject-id="${subject.id}" data-subject-name="${subject.name}" required>
    <option value="">--Select Faculty--</option>
    ${facultyForSubject.map(f=>`<option value="${f.id}">${f.name} (${f.initials})</option>`).join('')}
    </select>
    </div>
    `;
}
html+=`
<div class="subject-card">
    <h3>üìö ${subject.name} ${teachingDeptInfo}</h3>
    <div style="font-size:12px;color:var(--text-light);margin-bottom:15px; padding-bottom: 10px; border-bottom: 1px solid #e2e8f0;">
        Credits: ${subject.credits} | Type: ${subject.type} | Hours/Week: ${subject.weekly_hours}
    </div>
${sectionsHTML}
</div>
`;
});
html+='</div>';
container.innerHTML=html;
document.getElementById('subjectsDisplay').classList.add('hidden');
document.getElementById('facultyAssignment').classList.remove('hidden');
updateWizard(3);
}

async function openGenerator() {
    const generateBtn = document.querySelector('.btn-success');
    generateBtn.disabled = true;
    generateBtn.innerHTML = 'üöÄ Generating... Please Wait...';

    const ay = document.getElementById('academicYear').value.trim();
    const year = document.getElementById('yearSelect').value;
    const sem = document.getElementById('semesterSelect').value;
    const numSections = parseInt(document.getElementById('numSections').value) || 1;

    if (!ay || !year || !sem) {
        alert('Please complete all fields');
        generateBtn.disabled = false;
        generateBtn.innerHTML = 'üöÄ Generate Timetable';
        return;
    }
    
    const timetableData = {
        department: currentDepartment,
        semester: sem,
        year: year,
        academicYear: ay,
        sections: [],
        subjects: loadedSubjects,
        faculty: allFacultyList
    };

    for (let i = 1; i <= numSections; i++) {
        const sectionLetter = String.fromCharCode(64 + i);
        const sectionData = { name: sectionLetter, assignments: [] };
        for (const [idx, subject] of loadedSubjects.entries()) {
            const facultyId = document.getElementById(`faculty_s${i}_sub${idx}`).value;
            const faculty = allFacultyList.find(f => f.id == facultyId);
            if (!faculty) {
                alert(`Please assign faculty for ${subject.name} in Section ${sectionLetter}`);
                generateBtn.disabled = false;
                generateBtn.innerHTML = 'üöÄ Generate Timetable';
                return;
            }
            sectionData.assignments.push({
                subCode: subject.sub_code || '',
                subject: subject.name,
                subjectId: subject.id,
                faculty: faculty.name,
                facultyId: faculty.id,
                facultyInitials: faculty.initials,
                credits: subject.credits,
                type: subject.type,
                weekly_hours: subject.weekly_hours
            });
        }
        timetableData.sections.push(sectionData);
    }

    // Store data and redirect to enhanced.htm for generation
    localStorage.setItem('timetableData', JSON.stringify(timetableData));
    localStorage.setItem('currentDepartment', currentDepartment);
    
    console.log('Timetable data prepared:', timetableData);
    alert('‚úÖ Data prepared! Redirecting to timetable generator...');
    window.location.href = 'enhanced.htm';
}

document.getElementById('yearSelect').addEventListener('change', function() {
    const year = this.value;
    const semSelect = document.getElementById('semesterSelect');
    semSelect.innerHTML = '<option value="">--Select--</option>';
    semSelect.disabled = true;
    if (year) {
        const sems = {'1':['1','2'],'2':['3','4'],'3':['5','6'],'4':['7','8']}[year];
        sems.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s;
            opt.textContent = 'Semester ' + s;
            semSelect.appendChild(opt);
        });
        semSelect.disabled = false;
    }
});

loadAvailableData();
</script>
</body>
</html>