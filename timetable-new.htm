<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Timetable Generator - Setup</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #004085; --danger: #dc3545; --light-grey: #f8f9fa; --info: #17a2b8; --medium-blue: #0069d9; --success: #28a745; --warning: #ffc107; --text: #1e3c72; --muted: #6c757d; --border: #dee2e6; --card-bg: white; }
        * { box-sizing: border-box; }
        body { margin: 0; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); color: var(--text); font: 400 14px/1.5 'Segoe UI', Arial, sans-serif; min-height: 100vh; padding-top: 90px; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { display: flex; align-items: center; justify-content: space-between; padding: 5px 20px; background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); border-bottom: 3px solid #1e40af; flex-wrap: wrap; box-shadow: 0 4px 20px rgba(30, 64, 175, 0.3); width: 100vw; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; }
        .logo-left, .logo-right { width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; }
        .logo-left img, .logo-right img { width: 70px; height: 70px; object-fit: cover; border-radius: 50%; border: 2px solid rgba(255,255,255,0.3); }
        .header-text { text-align: center; flex: 1; min-width: 280px; }
        .header-text h1 { margin: 2px 0; font-weight: bold; font-size: 16px; line-height: 1.2; color: white; }
        .header-text h1:nth-child(2) { font-size: 20px; margin: 3px 0; }
        .main-grid { display: flex; flex-direction: column; gap: 20px; }
        .top-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
        .content-area { width: 100%; }
        .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(30, 64, 175, 0.08); transition: all 0.3s ease; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(30, 64, 175, 0.12); }
        .card h2 { margin: -20px -20px 20px -20px; font-size: 18px; color: var(--primary); font-weight: 700; padding: 15px 20px; background: #f8f9fa; border-bottom: 1px solid var(--border); border-radius: 12px 12px 0 0; }
        label { display: block; font-size: 13px; color: var(--text); margin-bottom: 6px; font-weight: 600; }
        input, select { width: 100%; padding: 10px 12px; border: 1px solid var(--border); background: #fdfdff; color: var(--text); border-radius: 8px; font-size: 14px; outline: none; transition: all 0.3s ease; }
        input:focus, select:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 10px; padding: 12px 24px; border: none; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600; text-decoration: none; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4); }
        .btn-success { background: linear-gradient(135deg, var(--success) 0%, #16a34a 100%); box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3); }
        .btn-success:hover { box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .input-group { display: flex; flex-direction: column; gap: 6px; }
        .faculty-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin-top: 20px; }
        .subject-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(30, 64, 175, 0.1); border-left: 4px solid var(--info); transition: all 0.3s; height: fit-content; }
        .subject-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(30, 64, 175, 0.15); }
        .subject-card h3 { font-size: 16px; color: var(--primary); margin: 0 0 12px 0; padding-bottom: 10px; border-bottom: 1px solid #e9ecef; font-weight: 700; }
        .section-row { display: grid; grid-template-columns: 70px 1fr; gap: 10px; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 6px; margin-bottom: 10px; transition: all 0.2s; }
        .section-row:hover { background: #e9ecef; }
        .section-row label { margin: 0; padding: 0; font-size: 13px; font-weight: 600; color: var(--primary); }
        .section-row select { font-size: 13px; padding: 8px; border-radius: 6px; }
        .subjects-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 20px; }
        .subject-item { padding: 15px; background: white; border-radius: 8px; border-left: 4px solid var(--info); box-shadow: 0 2px 8px rgba(30, 64, 175, 0.08); transition: all 0.3s; }
        .subject-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(30, 64, 175, 0.15); }
        .subject-item strong { color: var(--primary); font-size: 16px; display: block; margin-bottom: 8px; }
        .subject-item span { color: #666; font-size: 13px; display: block; line-height: 1.6; }
        .subject-item .badge { display: inline-block; padding: 4px 10px; background: var(--info); color: white; border-radius: 12px; font-size: 11px; margin-right: 5px; margin-top: 5px; }
        .hidden { display: none; }
    </style>
</head>
<body>
<div class="header">
<div class="logo-left"><img src="left-logo.png" alt="MET Logo"></div>
<div class="header-text">
<h1>üéì Maharaja Education Trust (R), Mysuru</h1>
<h1>üèõÔ∏è Maharaja Institute of Technology, Mysore</h1>
<h1>An Autonomous Institution Affiliated to VTU, Belagavi</h1>
<h1>‚úÖ Approved by AICTE, New Delhi | Recognized by Government of Karnataka</h1>
</div> 
<div class="logo-right"><img src="right-logo.png" alt="Circle Logo"></div>
</div>

<div class="container">
<div class="main-grid">
<div class="top-row">
<div class="card">
<h2>‚öôÔ∏è Quick Setup</h2>
<div class="input-group">
<label>Working Days</label> 
<select id="workingDays">
<option value="5">Monday to Friday (5 Days)</option>
<option value="6">Monday to Saturday (6 Days)</option>
<option value="5alt">Tuesday to Saturday (5 Days)</option>
</select>
</div>
<div class="input-group">
<label>Academic Year</label> 
<input id="academicYear" type="text" placeholder="e.g. 2024-25" value="2024-25" />
</div>
<div class="form-grid">
<div class="input-group">
<label>Year</label> 
<select id="yearSelect">
<option value="">--Select--</option>
<option value="1">1</option>
<option value="2">2</option>
<option value="3">3</option>
<option value="4">4</option>
</select>
</div>
<div class="input-group">
<label>Semester</label> 
<select id="semesterSelect">
<option value="">--Select--</option>
</select>
</div>
</div>
<div class="input-group">
<label>Number of Sections</label> 
<input id="numSections" type="number" min="1" max="10" value="1" />
</div>
</div>

<div class="card">
<h2>üìã Schedule Config</h2>
<div class="form-grid">
<div class="input-group">
<label>Periods per Day</label> 
<input id="periodsPerDay" type="number" min="4" max="10" value="7" />
</div>
<div class="input-group">
<label>Periods After Lunch</label> 
<input id="afterLunchPeriods" type="number" min="1" max="5" value="3" />
</div>
</div>
<div class="form-grid">
<div class="input-group">
<label>Start Time</label> 
<input id="startTime" type="time" value="09:00" />
</div>
<div class="input-group">
<label>End Time</label> 
<input id="endTime" type="time" value="17:00" />
</div>
</div>
<div class="form-grid">
<div class="input-group">
<label>Short Break Start</label> 
<input id="shortBreakStart" type="time" value="11:00" />
</div>
<div class="input-group">
<label>Short Break End</label> 
<input id="shortBreakEnd" type="time" value="11:15" />
</div>
</div>
<div class="form-grid">
<div class="input-group">
<label>Lunch Break Start</label> 
<input id="lunchBreakStart" type="time" value="13:00" />
</div>
<div class="input-group">
<label>Lunch Break End</label> 
<input id="lunchBreakEnd" type="time" value="14:00" />
</div>
</div>
</div>

<div class="card" id="timingPreviewCard">
<h2>‚è∞ Timing Preview</h2>
<div id="timingPreview" style="font-size:12px;line-height:1.6;color:var(--text);height:auto;border-radius:6px;padding:10px;background:#f8f9fa;"></div> 
</div>
</div>

<button class="btn" onclick="loadSubjects()" style="max-width:300px;margin:0 auto">‚û°Ô∏è Load Subjects</button>

<div class="content-area">
<div id="subjectsDisplay" class="hidden">
<h2 style="color:var(--primary);margin-bottom:20px;text-align:center;">üìö Loaded Subjects</h2> 
<div id="subjectsList"></div>
<button class="btn" onclick="showFacultyAssignment()" style="max-width:300px;margin:20px auto;">‚û°Ô∏è Assign Faculty</button>
</div>

<div id="facultyAssignment" class="hidden">
<h2 style="color:var(--primary);margin-bottom:20px;text-align:center;">üë®‚Äçüè´ Faculty Assignment</h2> 
<div id="subjectCards"></div>
<button class="btn btn-success" onclick="openGenerator()" style="margin-top:20px;max-width:300px">üöÄ Generate Timetable</button>
</div>
</div>
</div>
</div>

<script>
const SUPABASE_URL = 'https://bkmzyhroignpjebfpqug.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJrbXp5aHJvaWducGplYmZwcXVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MjA1NDUsImV4cCI6MjA3Mjk5NjU0NX0.ICE2eYzFZvz0dtNpAa5YlJTZD-idc2J76wn1ZeHwwck';
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
const urlParams=new URLSearchParams(window.location.search);
const currentDepartment=urlParams.get('dept')||localStorage.getItem('currentDepartment')||'ISE';
let loadedSubjects=[];
let allFacultyList=[]; // Will store faculty from all departments

async function loadAvailableData(){
try{
const{data,error}=await supabase.from('subjects').select('academic_year,year,semester').eq('department',currentDepartment);
if(error)throw error;
if(!data||data.length===0)return;
const uniqueYears=new Set();
data.forEach(d=>uniqueYears.add(d.academic_year));
const aySelect=document.getElementById('academicYear');
if(uniqueYears.size>0)aySelect.value=Array.from(uniqueYears)[0];
}catch(err){console.error(err)}
}

document.getElementById('yearSelect').onchange=function(){
const year=this.value;
const semSelect=document.getElementById('semesterSelect');
semSelect.innerHTML='<option value="">--Select--</option>';
if(year){
const sems={'1':['1','2'],'2':['3','4'],'3':['5','6'],'4':['7','8']}[year];
sems.forEach(s=>{
const opt=document.createElement('option');
opt.value=s;
opt.textContent='Semester '+s;
semSelect.appendChild(opt);
});
}
};

loadAvailableData();

async function loadSubjects(){
const ay=document.getElementById('academicYear').value.trim();
const year=document.getElementById('yearSelect').value;
const sem=document.getElementById('semesterSelect').value;
if(!ay||!year||!sem){alert('Please fill all fields');return}
try{
const{data,error}=await supabase.from('subjects').select('*').eq('department',currentDepartment).eq('academic_year',ay).eq('year',parseInt(year)).eq('semester',parseInt(sem));
if(error) throw error;
if(!data||data.length===0){alert('No subjects found');return}
loadedSubjects=data;
await loadAllFaculty(); // Load all faculty for cross-dept handling
displaySubjects();
}catch(err){alert('Error: '+err.message)}
}

async function loadAllFaculty(){
try{
const{data,error}=await supabase.from('faculty').select('*'); // Fetch all faculty
if(error)throw error;
allFacultyList=data||[];
}catch(err){console.error(err)}
}

function displaySubjects(){
const container=document.getElementById('subjectsList');
container.innerHTML='<div class="subjects-grid">'+loadedSubjects.map(s=>`
<div class="subject-item">
<strong>üìö ${s.name}</strong>
<span><span class="badge">${s.credits} Credits</span><span class="badge">${s.type}</span><span class="badge">${s.weekly_hours}h/week</span></span>
</div>
`).join('')+'</div>';
document.getElementById('subjectsDisplay').classList.remove('hidden');
document.getElementById('facultyAssignment').classList.add('hidden');
}

function showFacultyAssignment(){
const numSections=parseInt(document.getElementById('numSections').value)||1;
const container=document.getElementById('subjectCards');
let html='<div class="faculty-grid">';
loadedSubjects.forEach((subject,idx)=>{
    // Determine which faculty list to use
    const facultyForSubject = subject.is_cross_dept && subject.teaching_dept
        ? allFacultyList.filter(f => f.department === subject.teaching_dept)
        : allFacultyList.filter(f => f.department === currentDepartment);

    const teachingDeptInfo = subject.is_cross_dept ? `<span style="color: #f97316; font-weight: bold;">(Taught by ${subject.teaching_dept})</span>` : '';

let sectionsHTML='';
for(let i=1;i<=numSections;i++){
    const sectionLetter = String.fromCharCode(64 + i); // A, B, C, etc.
    sectionsHTML+=`
    <div class="section-row">
    <label>Sec ${sectionLetter}</label>
    <select id="faculty_s${i}_sub${idx}" data-subject-id="${subject.id}" required>
    <option value="">--Select Faculty--</option>
    ${facultyForSubject.map(f=>`<option value="${f.id}">${f.name} (${f.initials})</option>`).join('')}
    </select>
    </div>
    `;
}
html+=`
<div class="subject-card">
<h3>üìö ${subject.name} ${teachingDeptInfo}</h3>
<div style="font-size:11px;color:#666;margin-bottom:10px">
    Credits: ${subject.credits} | Type: ${subject.type} | Hours/Week: ${subject.weekly_hours}
</div>
${sectionsHTML}
</div>
`;
});
html+='</div>';
container.innerHTML=html;
document.getElementById('subjectsDisplay').classList.add('hidden');
document.getElementById('facultyAssignment').classList.remove('hidden');
}

async function openGenerator(){
const ay=document.getElementById('academicYear').value.trim();
const year=document.getElementById('yearSelect').value;
const sem=document.getElementById('semesterSelect').value;
const numSections=parseInt(document.getElementById('numSections').value)||1;

if(!ay||!year||!sem){alert('Please complete all fields');return}

const config={
academicYear:ay,
year:year,
semester:sem,
department:currentDepartment,
subjects:loadedSubjects,
sections:[],
workingDays:document.getElementById('workingDays').value,
periodsPerDay:document.getElementById('periodsPerDay').value,
afterLunchPeriods:document.getElementById('afterLunchPeriods').value,
startTime:document.getElementById('startTime').value,
endTime:document.getElementById('endTime').value,
shortBreakStart:document.getElementById('shortBreakStart').value,
shortBreakEnd:document.getElementById('shortBreakEnd').value,
lunchBreakStart:document.getElementById('lunchBreakStart').value,
lunchBreakEnd:document.getElementById('lunchBreakEnd').value
};

for(let i=1;i<=numSections;i++){
const sectionData={name:'Section '+i,subjectFaculty:[]};
loadedSubjects.forEach((subject,idx)=>{
const facultyId=document.getElementById(`faculty_s${i}_sub${idx}`).value;
const faculty=allFacultyList.find(f=>f.id==facultyId);
if(!faculty){alert(`Please assign faculty for ${subject.name} in Section ${i}`);return}
sectionData.subjectFaculty.push({
subject:subject.name,
subjectId:subject.id,
faculty:faculty.name,
facultyId:faculty.id,
facultyInitials:faculty.initials,
credits:subject.credits,
type:subject.type,
weekly_hours:subject.weekly_hours
});
});
config.sections.push(sectionData);
}

// Validate faculty assignments
let hasError = false;
for(let i=1;i<=numSections;i++){
    for(let idx=0;idx<loadedSubjects.length;idx++){
        const facultyId=document.getElementById(`faculty_s${i}_sub${idx}`).value;
        if(!facultyId){
            alert(`Please assign faculty for ${loadedSubjects[idx].name} in Section ${i}`);
            hasError = true;
            return;
        }
    }
}

if(hasError) return;

// Store timetable data in localStorage for enhanced.htm
const timetableData = {
    department: currentDepartment,
    semester: sem,
    year: year,
    academicYear: ay,
    sections: [],
    subjects: loadedSubjects, // All subjects for this sem/dept
    faculty: allFacultyList, // All faculty from all depts
    config: config
};

// Process sections with their faculty assignments
for(let i=1;i<=numSections;i++){
    const sectionLetter = String.fromCharCode(64 + i); // A, B, C, etc.
    const sectionData = {
        name: sectionLetter,
        assignments: []
    };
    
    loadedSubjects.forEach((subject,idx)=>{
        const facultyId=document.getElementById(`faculty_s${i}_sub${idx}`).value;
        const faculty=allFacultyList.find(f=>f.id==facultyId);
        
        sectionData.assignments.push({
            subCode: subject.sub_code || '',
            subject: subject.name,
            subjectId: subject.id,
            faculty: faculty.name,
            facultyId: faculty.id,
            facultyInitials: faculty.initials,
            credits: subject.credits,
            type: subject.type,
            weekly_hours: subject.weekly_hours
        });
    });
    
    timetableData.sections.push(sectionData);
}

localStorage.setItem('timetableData', JSON.stringify(timetableData));
window.location.href = 'enhanced.htm';
}

const quickSetupConfig={workingDays:document.getElementById('workingDays'),academicYear:document.getElementById('academicYear'),periodsPerDay:document.getElementById('periodsPerDay'),afterLunchPeriods:document.getElementById('afterLunchPeriods')};
const scheduleConfig={startTime:document.getElementById('startTime'),endTime:document.getElementById('endTime'),shortBreakStart:document.getElementById('shortBreakStart'),shortBreakEnd:document.getElementById('shortBreakEnd'),lunchBreakStart:document.getElementById('lunchBreakStart'),lunchBreakEnd:document.getElementById('lunchBreakEnd')};

function previewTimings(){
const periodsPerDay=parseInt(document.getElementById('periodsPerDay').value)||7;
const startTime=document.getElementById('startTime').value||'09:00';
const shortBreakStart=document.getElementById('shortBreakStart').value;
const shortBreakEnd=document.getElementById('shortBreakEnd').value;
const lunchBreakStart=document.getElementById('lunchBreakStart').value;
const lunchBreakEnd=document.getElementById('lunchBreakEnd').value;
const periodDuration=60;
const previewDiv=document.getElementById('timingPreview');
function formatIndianTime(date){return date.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true})}
const beforeShortBreak=2;
const afterShortBreak=2;
const afterLunch=periodsPerDay-beforeShortBreak-afterShortBreak;
let currentTime=new Date(`2024-01-01 ${startTime}:00`);
let preview='<div style="font-weight:bold;margin-bottom:8px;color:var(--primary);font-size:14px;text-align:center;">üìÖ Daily Schedule</div>';
for(let i=1;i<=beforeShortBreak;i++){
const endTime=new Date(currentTime.getTime()+periodDuration*60000);
preview+=`<div style="padding:4px 8px;border-left:3px solid var(--info);background:#f1f5f9;margin:4px 0;border-radius:4px;"><strong>P${i}:</strong> ${formatIndianTime(currentTime)} - ${formatIndianTime(endTime)}</div>`;
currentTime=endTime;
}
const shortStart=new Date(`2024-01-01 ${shortBreakStart}:00`);
const shortEnd=new Date(`2024-01-01 ${shortBreakEnd}:00`);
preview+=`<div style="padding:4px 8px;background:#fffbeb;border-left:3px solid var(--warning);margin:4px 0;border-radius:4px;font-weight:600;">‚òï Short Break: ${formatIndianTime(shortStart)} - ${formatIndianTime(shortEnd)}</div>`;
currentTime=new Date(`2024-01-01 ${shortBreakEnd}:00`);
for(let i=beforeShortBreak+1;i<=beforeShortBreak+afterShortBreak;i++){
const endTime=new Date(currentTime.getTime()+periodDuration*60000);
preview+=`<div style="padding:4px 8px;border-left:3px solid var(--info);background:#f1f5f9;margin:4px 0;border-radius:4px;"><strong>P${i}:</strong> ${formatIndianTime(currentTime)} - ${formatIndianTime(endTime)}</div>`;
currentTime=endTime;
}
const lunchStart=new Date(`2024-01-01 ${lunchBreakStart}:00`);
const lunchEnd=new Date(`2024-01-01 ${lunchBreakEnd}:00`);
preview+=`<div style="padding:6px 8px;background:#f0fdf4;border-left:3px solid var(--success);margin:4px 0;border-radius:4px;font-weight:bold;text-align:center;">üçΩÔ∏è Lunch Break: ${formatIndianTime(lunchStart)} - ${formatIndianTime(lunchEnd)}</div>`;
currentTime=new Date(`2024-01-01 ${lunchBreakEnd}:00`);
for(let i=beforeShortBreak+afterShortBreak+1;i<=periodsPerDay;i++){
const endTime=new Date(currentTime.getTime()+periodDuration*60000);
preview+=`<div style="padding:4px 8px;border-left:3px solid var(--info);background:#f1f5f9;margin:4px 0;border-radius:4px;"><strong>P${i}:</strong> ${formatIndianTime(currentTime)} - ${formatIndianTime(endTime)}</div>`;
currentTime=endTime;
}
previewDiv.innerHTML=preview;
}

Object.values(quickSetupConfig).forEach(element=>{element.addEventListener('change',previewTimings);element.addEventListener('input',previewTimings)});
Object.values(scheduleConfig).forEach(element=>{element.addEventListener('change',previewTimings);element.addEventListener('input',previewTimings)});
previewTimings();
loadAvailableData();
</script>
</body>
</html>